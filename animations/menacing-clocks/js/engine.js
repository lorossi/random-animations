/**
 * HTML canvas simple engine.
 * GitHub repo and documentation: https://github.com/lorossi/empty-html5-canvas-project
 * @author Lorenzo Rossi <mail@lorenzoros.si>
 * @license MIT - 2022
 */
import{XOR128}from"./xor128.js";import{createNoise2D,createNoise3D,createNoise4D}from"./simplex-noise.js";const CSS_COLOR_NAMES={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]};Object.freeze(CSS_COLOR_NAMES);const SANZO_WADA_COLORS={aconiteviolet:[156,82,242],andovergreen:[92,138,115],antwarpblue:[0,138,161],apricotorange:[255,115,64],apricotyellow:[255,230,0],artemesiagreen:[101,169,143],benzolgreen:[0,217,115],black:[0,0,0],blackisholive:[50,78,42],blue:[13,117,255],blueviolet:[71,51,255],brickred:[163,33,0],brown:[108,43,17],buffycitrine:[136,141,42],burntsienna:[169,52,0],calamineblue:[128,255,204],cameopink:[230,173,207],carmine:[214,0,54],carminered:[161,11,43],cerulianblue:[41,189,173],cinnamonbuff:[255,191,110],cinnamonrufous:[194,97,44],citronyellow:[166,212,13],cobaltgreen:[148,255,148],coralred:[255,115,153],corinthianpink:[255,166,217],cossackgreen:[50,142,19],cotingapurple:[52,0,89],creamyellow:[255,184,82],darkcitrine:[126,135,67],darkgreenishglaucous:[179,217,163],darkmediciblue:[65,119,119],darkslatepurple:[83,34,92],darksoftviolet:[77,82,222],darktyrianblue:[13,43,82],deepgrayisholive:[80,84,35],deepindigo:[0,8,49],deeplyonsblue:[0,36,204],deepslategreen:[15,38,31],deepslateolive:[23,39,19],deepvioletplumbeous:[92,114,135],diaminegreen:[27,142,19],dullblueviolet:[110,102,212],dullvioletblack:[6,0,79],dullviridiangreen:[25,204,51],duskygreen:[0,89,46],duskymadderviolet:[45,0,96],ecru:[192,180,144],englishred:[222,69,0],eosinepink:[255,94,196],etruscanred:[201,48,62],eugeniareda:[237,61,102],eugeniaredb:[230,46,115],eupatoriumpurple:[191,54,224],fawn:[209,176,179],freshcolor:[255,120,140],glaucousgreen:[179,232,194],goldenyellow:[250,148,66],grayishlavendera:[184,184,255],grayishlavenderb:[191,171,204],green:[64,201,69],greenblue:[45,188,148],grenadinepink:[255,97,107],haysrusset:[104,25,22],helvetiablue:[0,87,186],hermosapink:[255,179,240],hydrangeared:[158,25,77],indianlake:[204,26,151],isabellacolor:[195,165,92],ivorybuff:[235,217,153],jasperred:[250,43,0],khaki:[182,132,0],krongbergsgreen:[117,146,67],laeliapink:[204,133,209],lemonyellow:[242,255,38],lightbrowndrab:[176,134,153],lightbrownisholive:[112,105,52],lightglaucousblue:[166,230,219],lightgrayisholive:[118,132,78],lightgreenyellow:[189,242,38],lightmauve:[145,97,242],lightpinkishcinnamon:[255,191,153],lightporcelaingreen:[35,193,124],lilac:[184,117,235],lincolngreen:[64,84,22],madderbrown:[101,19,0],maple:[194,151,90],marsbrowntobacco:[82,32,0],mineralgray:[159,194,178],naplesyellow:[250,237,143],neutralgray:[181,209,204],nightgreen:[122,255,0],nileblue:[191,255,230],ochraceoussalmon:[217,158,115],ochrered:[167,55,75],oilgreen:[110,169,0],oldrose:[217,77,153],olive:[113,134,0],olivebuff:[188,211,130],olivegreen:[88,119,30],oliveocher:[209,189,25],oliveyellow:[153,179,51],olympicblue:[79,143,230],orange:[255,82,0],orangecitrine:[140,101,16],orangerufous:[192,82,0],orangeyellow:[255,171,0],paleburntlake:[115,15,31],palekingsblue:[171,245,237],palelemonyellow:[255,245,158],palerawumber:[94,64,23],pansypurple:[111,0,67],peachred:[255,51,25],peacockblue:[0,207,145],pinkishcinnamon:[242,173,120],pistachiogreen:[86,170,105],pomegranitepurple:[185,0,120],pompeianred:[169,6,54],purpledrab:[117,66,96],pyriteyellow:[196,191,51],rainettegreen:[133,184,87],rawsienna:[184,94,0],red:[161,0,69],redorange:[232,25,0],redviolet:[52,0,163],rosolancpurple:[179,25,171],salviablue:[150,191,230],scarlet:[213,12,66],seagreen:[51,255,125],seashellpink:[255,207,196],sepia:[80,61,0],slatecolor:[27,54,68],spectrumred:[242,0,0],spinelred:[255,77,201],sudanbrown:[155,83,72],sulpheryellow:[245,245,184],sulphineyellow:[186,166,0],taupebrown:[107,46,99],turquoisegreen:[181,255,194],vandarpoelsblue:[0,62,131],vandykebrown:[54,35,4],vandykered:[116,9,9],venicegreen:[107,255,179],veroniapurple:[126,48,117],vinaceouscinnamon:[245,153,148],vinaceoustawny:[199,67,0],violet:[38,25,209],violetblue:[32,45,133],violetcarmine:[83,23,69],violetred:[61,0,121],vistorislake:[92,44,69],warmgray:[156,178,158],white:[255,255,255],yellow:[255,255,0],yellowgreen:[166,255,71],yellowocher:[224,184,31],yelloworange:[255,140,0]};Object.freeze(SANZO_WADA_COLORS);class Engine{constructor(e,t,r=60){this._canvas=e,this._ctx=t,this._fps=r,this._frame_count=0,this._no_loop=!1,this._is_recording=!1,this._first_frame_recorded=0,this._frames_recorded=0,this._zip=null,this._dt=1/0,this._started=0,this._fps_buffer=new CircularBuffer(60),this._mouseCoords=new Point(0,0),this._prevMouseCoords=new Point(0,0),this._setFps(this._fps),this._run()}_setFps(e){this._fps=e,this._fps_interval=1e3/this._fps}_run(){this.preload(),this.setup(),this._ctx.imageSmoothingQuality="high",this._timeDraw()}_timeDraw(){if(window.requestAnimationFrame(this._timeDraw.bind(this)),this._no_loop)return;if(this._ctx.save(),this.draw(),this._ctx.restore(),this._is_recording){const e=(this._frame_count-this._first_frame_recorded).toString().padStart(7,0)+".png",t=this._canvas.toDataURL("image/png").split(";base64,")[1];this._zip.file(e,t,{base64:!0}),this._frames_recorded++}this._frame_count++;const e=performance.now();if(0!=this._started){const t=e-this._started;this._fps_buffer.push(1e3/t),this._dt=t}this._started=e}loop(){this._no_loop=!1}noLoop(){this._no_loop=!0}startRecording(){this._is_recording=!0,this._first_frame_recorded=this._frame_count,this._frames_recorded=0,this._zip=new JSZip}stopRecording(){this._is_recording=!1}saveRecording(e="frames.zip"){this._is_recording||null==this._zip||0==this._frames_recorded||this._zip.generateAsync({type:"blob"}).then(t=>{const r=URL.createObjectURL(t);this._downloadFile(e,r)})}saveFrame(e=null){null==e&&(e="frame-"+this._frame_count.toString().padStart(6,0)),this._downloadFile(e,this._canvas.toDataURL("image/png"))}_calculatePressCoords(e){const t=this._canvas.getBoundingClientRect(),r=Math.min(t.width,t.height)/this._canvas.getAttribute("width");if("touches"in e){if(e.touches.length>0){const s=(e.touches[0].pageX-t.left)/r,i=(e.touches[0].pageY-t.top)/r;return new Point(s,i)}return new Point(-1,-1)}{const s=(e.pageX-t.left)/r,i=(e.pageY-t.top)/r;return new Point(s,i)}}_downloadFile(e,t){const r=document.createElement("a");r.href=t,r.setAttribute("download",e),document.body.appendChild(r),r.click(),document.body.removeChild(r)}_clickCallback(e){const t=this._calculatePressCoords(e);this.click(t.x,t.y)}_mouseDownCallback(e){this._mouse_pressed=!0;const t=this._calculatePressCoords(e);this.mouseDown(t.x,t.y)}_mouseUpCallback(e){this._mouse_pressed=!1;const t=this._calculatePressCoords(e);this.mouseUp(t.x,t.y)}_mouseMoveCallback(e){const t=this._calculatePressCoords(e);this._prevMouseCoords=this._mouseCoords.copy(),this._mouseCoords=t.copy(),this._mouse_pressed?this.mouseDragged(t.x,t.y):this.mouseMoved(t.x,t.y)}_keyDownCallback(e){this.keyDown(e.key,e.keyCode)}_keyUpCallback(e){this.keyUp(e.key,e.keyCode)}_keyPressCallback(e){this.keyPress(e.key,e.keyCode)}click(e,t){}mouseDown(e,t){}mouseDragged(e,t){}mouseUp(e,t){}mouseMoved(e,t){}keyPress(e,t){}keyDown(e,t){}keyUp(e,t){}background(e){this._ctx.save(),this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height),this._ctx.fillStyle="number"==typeof e?Color.fromMonochrome(e).rgba:e instanceof Color?e.rgba:e,this._ctx.fillRect(0,0,this._canvas.width,this._canvas.height),this._ctx.restore()}scaleFromCenter(e,t=null){null==t&&(t=e),this._ctx.translate(this._canvas.width/2,this._canvas.height/2),this._ctx.scale(e,t),this._ctx.translate(-this._canvas.width/2,-this._canvas.height/2)}preload(){}setup(){}draw(){}get ctx(){return this._ctx}get recording(){return this._is_recording}get canvas(){return this._canvas}get frameCount(){return this._frame_count}get frameRate(){return this._fps_buffer.average}get deltaTime(){return this._dt}set deltaTime(e){this._setFps(1e3/e)}set frameRate(e){this._setFps(e)}get width(){return this._canvas.width}get height(){return this._canvas.height}get is_recording(){return this._is_recording}get mousePosition(){return this._mouseCoords.copy()}get prevMousePosition(){return this._prevMouseCoords.copy()}}class Color{constructor(e=0,t=0,r=0,s=1){if(e>255||e<0||t>255||t<0||r>255||r<0)throw new Error("Color values must be in range [0, 255]");if(s>1||s<0)throw new Error("Alpha value must be in range [0, 1]");this._r=e,this._g=t,this._b=r,this._a=s,this._calculateHsl()}equals(e,t=!0){const r=(e,t)=>Math.abs(e-t)<1e-4;return r(this._r,e._r)&&r(this._g,e._g)&&r(this._b,e._b)&&(r(this._a,e._a)||!t)}toString(){return this.hex}mix(e,t,r=null){const s=r?r(t):t,i=this._clamp(this._r+s*(e.r-this._r),0,255),a=this._clamp(this._g+s*(e.g-this._g),0,255),o=this._clamp(this._b+s*(e.b-this._b),0,255),l=this._clamp(this._a+s*(e.a-this._a),0,1);return new Color(i,a,o,l)}darken(e,t=null){const r=t?t(e):e;return this.mix(Color.fromMonochrome(0),r)}lighten(e,t=null){const r=t?t(e):e;return this.mix(Color.fromMonochrome(255),r)}copy(){return new Color(this._r,this._g,this._b,this._a)}static fromHSL(e,t,r,s){const i=new Color;return i.h=e,i.s=t,i.l=r,i._calculateRgb(),new Color(i._r,i._g,i._b,s)}static fromRGB(e,t,r,s){return new Color(e,t,r,s)}static fromHex(e){const[,t,r,s,i]=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})?$/i.exec(e),a=parseInt(t,16),o=parseInt(r,16),l=parseInt(s,16),n=i?parseInt(i,16)/255:1;return new Color(a,o,l,n)}static fromHEX(e){return Color.fromHex(e)}static fromMonochrome(e,t=1){return new Color(e,e,e,t)}static fromCSS(e){if(null==CSS_COLOR_NAMES[e])throw new Error("Color name not found");return new Color(...CSS_COLOR_NAMES[e])}static fromSanzoWada(e){if(null==SANZO_WADA_COLORS[e])throw new Error("Color name not found");return new Color(...SANZO_WADA_COLORS[e])}_calculateHsl(){const e=this._r/255,t=this._g/255,r=this._b/255;let s,i,a=Math.max(e,t,r),o=Math.min(e,t,r),l=(a+o)/2;if(a==o)s=i=0;else{let n=a-o;switch(i=l>.5?n/(2-a-o):n/(a+o),a){case e:s=(t-r)/n+(t<r?6:0);break;case t:s=(r-e)/n+2;break;case r:s=(e-t)/n+4}s/=6}this._h=Math.floor(360*s),this._s=Math.floor(100*i),this._l=Math.floor(100*l)}_calculateRgb(){if(0==this._s)this._r=this._l,this._g=this._l,this._b=this._l;else{const e=(e,t,r)=>(r<0&&(r+=1),r>1&&(r-=1),r<1/6?e+6*(t-e)*r:r<.5?t:r<2/3?e+(t-e)*(2/3-r)*6:e),t=this._l/100,r=this._h/360,s=this._s/100;let i=t<.5?t*(1+s):t+s-t*s,a=2*t-i;this._r=Math.floor(255*e(a,i,r+1/3)),this._g=Math.floor(255*e(a,i,r)),this._b=Math.floor(255*e(a,i,r-1/3))}}_decToHex(e){return Math.floor(e).toString(16).padStart(2,0).toUpperCase()}_hexToDec(e){return parseInt(e,16)}_clamp(e,t,r){return Math.min(Math.max(t,e),r)}set hex(e){this._r=this._hexToDec(e.slice(1,3)),this._g=this._hexToDec(e.slice(3,5)),this._b=this._hexToDec(e.slice(5,7));const t=parseInt(e.slice(7,9),16);isNaN(t)?this._a=1:this._a=this._clamp(t/255,0,1),this._calculateHsl()}get_hex(){return`#${this._decToHex(this._r)}${this._decToHex(this._g)}${this._decToHex(this._b)}`}get hex(){return this.get_hex()}get_hexa(){return`#${this._decToHex(this._r)}${this._decToHex(this._g)}${this._decToHex(this._b)}${this._decToHex(255*this._a)}`}get hexa(){return this.get_hexa()}get_rgb(){const[e,t,r]=[this._r,this._g,this._b].map(Math.floor);return`rgb(${e}, ${t}, ${r})`}get rgb(){return this.get_rgb()}get_rgba(){const[e,t,r]=[this._r,this._g,this._b].map(Math.floor);return`rgba(${e}, ${t}, ${r}, ${this._a})`}get rgba(){return this.get_rgba()}get_hsl(){const[e,t,r]=[this._h,this._s,this._l].map(Math.floor);return`hsl(${e}, ${t}%, ${r}%)`}get hsl(){return this.get_hsl()}get_hsla(){const[e,t,r]=[this._h,this._s,this._l].map(Math.floor);return`hsla(${e}, ${t}%, ${r}%, ${this._a})`}get hsla(){return this.get_hsla()}get r(){return this._r}set r(e){this._r=Math.floor(this._clamp(e,0,255)),this._calculateHsl()}get g(){return this._g}set g(e){this._g=Math.floor(this._clamp(e,0,255)),this._calculateHsl()}get b(){return this._b}set b(e){this._b=Math.floor(this._clamp(e,0,255)),this._calculateHsl()}get a(){return this._a}set a(e){this._a=this._clamp(e,0,1)}get h(){return this._h}set h(e){this._h=Math.floor(this._clamp(e,0,360)),this._calculateRgb()}get s(){return this._s}set s(e){this._s=Math.floor(this._clamp(e,0,100)),this._calculateRgb()}get l(){return this._l}set l(e){this._l=Math.floor(this._clamp(e,0,100)),this._calculateRgb()}get is_monochrome(){return this._r==this._g&&this._g==this._b}get luminance(){const e=this._r/255,t=this._g/255,r=this._b/255;return.2126*(e<=.03928?e/12.92:Math.pow((e+.055)/1.055,2.4))+.7152*(t<=.03928?t/12.92:Math.pow((t+.055)/1.055,2.4))+.0722*(r<=.03928?r/12.92:Math.pow((r+.055)/1.055,2.4))}}class Point{constructor(e,t){if(2!=arguments.length)throw new Error("Point must have only two coordinates");this._x=e,this._y=t}copy(){return new Point(this._x,this._y)}distance(e){return Math.sqrt((e.x-this._x)**2+(e.y-this._y)**2)}equals(e){const t=(e,t)=>Math.abs(e-t)<1e-4;return t(this._x,e.x)&&t(this._y,e.y)}toString(){return`(${this._x}, ${this._y})`}get x(){return this._x}set x(e){this._x=e}get y(){return this._y}set y(e){this._y=e}}class SimplexNoise{constructor(e=null){let t;if(e){let r,s,i,a;if("number"==typeof e)r=e,s=e+1,i=e+2,a=e+3;else if("string"==typeof e){const t=this._hash(e);r=t,s=t+1,i=t+2,a=t+3}else Array.isArray(e)&&(r=e[0],s=e[1],i=e[2],a=e[3]);t=new XOR128(r,s,i,a)}else t=new XOR128;this._noise={2:createNoise2D(t),3:createNoise3D(t),4:createNoise4D(t)},this._octaves=1,this._falloff=.5,this._max_value=this._calculateMaxValue()}_hash(e){if(0==e.length)return 0;let t=0;for(let r=0;r<e.length;r++){t=(t<<5)-t+e.charCodeAt(r),t&=t}return t}noise(e,t,r=null,s=null){let i=0,a=1,o=1;const l=Math.min(Math.max(arguments.length,2),4);for(let n=0;n<this._octaves;n++)i+=this._noise[l](e*o,t*o,r*o,s*o)*a,a*=this._falloff,o*=1/this._falloff;return i/this._max_value}setDetail(e=1,t=.5){this._octaves=e,this._falloff=t,this._max_value=this._calculateMaxValue()}_calculateMaxValue(){let e=0;for(let t=0;t<this._octaves;t++)e+=this._falloff**t;return e}set octaves(e){this._octaves=e,this._max_value=this._calculateMaxValue()}get octaves(){return this._octaves}set falloff(e){this._falloff=e,this._max_value=this._calculateMaxValue()}get falloff(){return this._falloff}get max_value(){return this._max_value}get min_value(){return-this.max_value}}class CircularBuffer{constructor(e){this._buffer=new Array(e).fill(null),this._size=e,this._index=0}push(e){this._buffer[this._index]=e,this._index=(this._index+1)%this._size}get average(){const e=this._buffer.filter(e=>null!=e);return 0==e.length?0:e.reduce((e,t)=>e+t,0)/e.length}}export{Point,Color,Engine,SimplexNoise};